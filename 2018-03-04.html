<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>日報 2018-03-04</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <style>/*! normalize.css v8.0.0 | MIT License | github.com/necolas/normalize.css */  /* Document    ========================================================================== */  /**  * 1. Correct the line height in all browsers.  * 2. Prevent adjustments of font size after orientation changes in iOS.  */  html {   line-height: 1.15; /* 1 */   -webkit-text-size-adjust: 100%; /* 2 */ }  /* Sections    ========================================================================== */  /**  * Remove the margin in all browsers.  */  body {   margin: 0; }  /**  * Correct the font size and margin on `h1` elements within `section` and  * `article` contexts in Chrome, Firefox, and Safari.  */  h1 {   font-size: 2em;   margin: 0.67em 0; }  /* Grouping content    ========================================================================== */  /**  * 1. Add the correct box sizing in Firefox.  * 2. Show the overflow in Edge and IE.  */  hr {   box-sizing: content-box; /* 1 */   height: 0; /* 1 */   overflow: visible; /* 2 */ }  /**  * 1. Correct the inheritance and scaling of font size in all browsers.  * 2. Correct the odd `em` font sizing in all browsers.  */  pre {   font-family: monospace, monospace; /* 1 */   font-size: 1em; /* 2 */ }  /* Text-level semantics    ========================================================================== */  /**  * Remove the gray background on active links in IE 10.  */  a {   background-color: transparent; }  /**  * 1. Remove the bottom border in Chrome 57-  * 2. Add the correct text decoration in Chrome, Edge, IE, Opera, and Safari.  */  abbr[title] {   border-bottom: none; /* 1 */   text-decoration: underline; /* 2 */   text-decoration: underline dotted; /* 2 */ }  /**  * Add the correct font weight in Chrome, Edge, and Safari.  */  b, strong {   font-weight: bolder; }  /**  * 1. Correct the inheritance and scaling of font size in all browsers.  * 2. Correct the odd `em` font sizing in all browsers.  */  code, kbd, samp {   font-family: monospace, monospace; /* 1 */   font-size: 1em; /* 2 */ }  /**  * Add the correct font size in all browsers.  */  small {   font-size: 80%; }  /**  * Prevent `sub` and `sup` elements from affecting the line height in  * all browsers.  */  sub, sup {   font-size: 75%;   line-height: 0;   position: relative;   vertical-align: baseline; }  sub {   bottom: -0.25em; }  sup {   top: -0.5em; }  /* Embedded content    ========================================================================== */  /**  * Remove the border on images inside links in IE 10.  */  img {   border-style: none; }  /* Forms    ========================================================================== */  /**  * 1. Change the font styles in all browsers.  * 2. Remove the margin in Firefox and Safari.  */  button, input, optgroup, select, textarea {   font-family: inherit; /* 1 */   font-size: 100%; /* 1 */   line-height: 1.15; /* 1 */   margin: 0; /* 2 */ }  /**  * Show the overflow in IE.  * 1. Show the overflow in Edge.  */  button, input { /* 1 */   overflow: visible; }  /**  * Remove the inheritance of text transform in Edge, Firefox, and IE.  * 1. Remove the inheritance of text transform in Firefox.  */  button, select { /* 1 */   text-transform: none; }  /**  * Correct the inability to style clickable types in iOS and Safari.  */  button, [type="button"], [type="reset"], [type="submit"] {   -webkit-appearance: button; }  /**  * Remove the inner border and padding in Firefox.  */  button::-moz-focus-inner, [type="button"]::-moz-focus-inner, [type="reset"]::-moz-focus-inner, [type="submit"]::-moz-focus-inner {   border-style: none;   padding: 0; }  /**  * Restore the focus styles unset by the previous rule.  */  button:-moz-focusring, [type="button"]:-moz-focusring, [type="reset"]:-moz-focusring, [type="submit"]:-moz-focusring {   outline: 1px dotted ButtonText; }  /**  * Correct the padding in Firefox.  */  fieldset {   padding: 0.35em 0.75em 0.625em; }  /**  * 1. Correct the text wrapping in Edge and IE.  * 2. Correct the color inheritance from `fieldset` elements in IE.  * 3. Remove the padding so developers are not caught out when they zero out  *    `fieldset` elements in all browsers.  */  legend {   box-sizing: border-box; /* 1 */   color: inherit; /* 2 */   display: table; /* 1 */   max-width: 100%; /* 1 */   padding: 0; /* 3 */   white-space: normal; /* 1 */ }  /**  * Add the correct vertical alignment in Chrome, Firefox, and Opera.  */  progress {   vertical-align: baseline; }  /**  * Remove the default vertical scrollbar in IE 10+.  */  textarea {   overflow: auto; }  /**  * 1. Add the correct box sizing in IE 10.  * 2. Remove the padding in IE 10.  */  [type="checkbox"], [type="radio"] {   box-sizing: border-box; /* 1 */   padding: 0; /* 2 */ }  /**  * Correct the cursor style of increment and decrement buttons in Chrome.  */  [type="number"]::-webkit-inner-spin-button, [type="number"]::-webkit-outer-spin-button {   height: auto; }  /**  * 1. Correct the odd appearance in Chrome and Safari.  * 2. Correct the outline style in Safari.  */  [type="search"] {   -webkit-appearance: textfield; /* 1 */   outline-offset: -2px; /* 2 */ }  /**  * Remove the inner padding in Chrome and Safari on macOS.  */  [type="search"]::-webkit-search-decoration {   -webkit-appearance: none; }  /**  * 1. Correct the inability to style clickable types in iOS and Safari.  * 2. Change font properties to `inherit` in Safari.  */  ::-webkit-file-upload-button {   -webkit-appearance: button; /* 1 */   font: inherit; /* 2 */ }  /* Interactive    ========================================================================== */  /*  * Add the correct display in Edge, IE 10+, and Firefox.  */  details {   display: block; }  /*  * Add the correct display in all browsers.  */  summary {   display: list-item; }  /* Misc    ========================================================================== */  /**  * Add the correct display in IE 10+.  */  template {   display: none; }  /**  * Add the correct display in IE 10.  */  [hidden] {   display: none; } html, body {   height: 100%; } body {   max-width: 700px;   margin: auto;   padding: 0px 10px;   line-height: 1.6;   font-size: 16px;   font-family: sans-serif; } img.emoji {   height: 1em;   width: 1em;   margin: 0 .05em 0 .1em;   vertical-align: -0.1em; } img {   max-width: 100%; } pre {   line-height: 1.4;   font-size: 14px; }</style>
</head>
<body>
<header>
<h1 class="title">日報 2018-03-04</h1>
</header>
<table>
<tbody>
<tr class="odd">
<td style="text-align: left;">10:30~</td>
<td style="text-align: center;">起床</td>
</tr>
<tr class="even">
<td style="text-align: left;">11:30~</td>
<td style="text-align: center;">昼食</td>
</tr>
<tr class="odd">
<td style="text-align: left;">13:00~</td>
<td style="text-align: center;">無</td>
</tr>
<tr class="even">
<td style="text-align: left;">14:00~</td>
<td style="text-align: center;">スクレイピング</td>
</tr>
<tr class="odd">
<td style="text-align: left;">17:00~</td>
<td style="text-align: center;">無</td>
</tr>
<tr class="even">
<td style="text-align: left;">18:30~</td>
<td style="text-align: center;">夕食</td>
</tr>
<tr class="odd">
<td style="text-align: left;">19:30~</td>
<td style="text-align: center;">スクレイピング</td>
</tr>
<tr class="even">
<td style="text-align: left;">24:30~</td>
<td style="text-align: center;">シャワー</td>
</tr>
<tr class="odd">
<td style="text-align: left;">28:00~</td>
<td style="text-align: center;">スクレイピング</td>
</tr>
</tbody>
</table>
<p>今日は昨日より少し早く起きることができた。</p>
<p>頭が少し痛い。昔は頭が痛い時は間違いなく風だったので安静にして寝れば治ったが、大学生になってカフェイン切れによる頭痛も起きるようになって、2つの区別がなかなかつかなくて困る。</p>
<p>久しぶりに悪夢を見た。車を運転しようとして上手くいかなくて死ぬ夢と気づくと英語のエッセイの提出期限がとっくに過ぎている夢だ。昔は車に乗ったり運転したりする行為について特になんとも思っていなかったが自動運転やら飛行機による移動と比較したときの致死率等の話を聞いていくうちにモヤモヤした気持ち<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>になるようになった。</p>
<p>Elmの作者による <a href="https://www.youtube.com/watch?v=oYk8CKH7OhE">Let’s be mainstream! User focused design in Elm</a> を久しぶりに見返した。Elmの学習曲線は例えばHaskellのと比べ物にならないほど緩やかで、それはたまたまそうなったわけではなく意図してそうなるように設計されたんだなぁと見る度に思う。SATySFiは普及すればするほどみんながハッピーになれる<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a> だろうし、成功してほしい。</p>
<p>Elmと言えばパッケージマネージャがsemverを型シグネチャを見て強制している。革命的だと思うが、他の言語でこういうことをやっているところを見たことがない。 ML/Haskell系の言語<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a>がそもそも少ないからかもしれない。</p>
<p>声優の氏名は固有だという前提でスキーマを組んだら「前田愛」さんが2人居た… どうしようか。</p>
<p>氏名に関する一意性制約をなくしたら上手くいった。Persistent簡単に使えて便利だ。</p>
<p>得られた全声優のデータをSQLiteに突っ込んで、各声優のページをクロールして出演作品もDBに取り込んでいる。リクエスト毎に1秒おいて声優4000人前後居るから数時間かかりそう。</p>
<p>DBのスキーマはこんな感じで落ち着いた。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="ot">{-# LANGUAGE EmptyDataDecls #-}</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="ot">{-# LANGUAGE FlexibleContexts #-}</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="ot">{-# LANGUAGE GADTs #-}</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="ot">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="ot">{-# LANGUAGE MultiParamTypeClasses #-}</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="ot">{-# LANGUAGE QuasiQuotes #-}</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="ot">{-# LANGUAGE TemplateHaskell #-}</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="ot">{-# LANGUAGE TypeFamilies #-}</span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="ot">{-# LANGUAGE DeriveGeneric #-}</span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11"><span class="kw">module</span> <span class="dt">Model</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-12" data-line-number="12"></a>
<a class="sourceLine" id="cb1-13" data-line-number="13"><span class="kw">import</span> <span class="dt">Control.Monad.Trans.Control</span></a>
<a class="sourceLine" id="cb1-14" data-line-number="14"><span class="kw">import</span> <span class="dt">Control.Monad.Trans.Reader</span></a>
<a class="sourceLine" id="cb1-15" data-line-number="15"><span class="kw">import</span> <span class="dt">Control.Monad.IO.Class</span></a>
<a class="sourceLine" id="cb1-16" data-line-number="16"><span class="kw">import</span> <span class="dt">Control.Monad.Logger</span></a>
<a class="sourceLine" id="cb1-17" data-line-number="17"><span class="kw">import</span> <span class="dt">Control.Monad.Trans.Resource</span></a>
<a class="sourceLine" id="cb1-18" data-line-number="18"><span class="co">--import Data.Aeson</span></a>
<a class="sourceLine" id="cb1-19" data-line-number="19"><span class="kw">import</span> <span class="dt">Data.Text</span></a>
<a class="sourceLine" id="cb1-20" data-line-number="20"><span class="co">--import Database.Persist</span></a>
<a class="sourceLine" id="cb1-21" data-line-number="21"><span class="kw">import</span> <span class="dt">Database.Persist.TH</span></a>
<a class="sourceLine" id="cb1-22" data-line-number="22"><span class="kw">import</span> <span class="dt">Database.Persist.Sqlite</span></a>
<a class="sourceLine" id="cb1-23" data-line-number="23"><span class="kw">import</span> <span class="dt">GHC.Generics</span></a>
<a class="sourceLine" id="cb1-24" data-line-number="24"></a>
<a class="sourceLine" id="cb1-25" data-line-number="25">share [mkPersist sqlSettings, mkMigrate <span class="st">&quot;migrateAll&quot;</span>] [persistLowerCase|</a>
<a class="sourceLine" id="cb1-26" data-line-number="26">Anime</a>
<a class="sourceLine" id="cb1-27" data-line-number="27">    title Text</a>
<a class="sourceLine" id="cb1-28" data-line-number="28">    href Text</a>
<a class="sourceLine" id="cb1-29" data-line-number="29">    UniqueAnimeTitle title href</a>
<a class="sourceLine" id="cb1-30" data-line-number="30">    deriving Show</a>
<a class="sourceLine" id="cb1-31" data-line-number="31">    deriving Generic</a>
<a class="sourceLine" id="cb1-32" data-line-number="32">Actor</a>
<a class="sourceLine" id="cb1-33" data-line-number="33">    name Text</a>
<a class="sourceLine" id="cb1-34" data-line-number="34">    href Text Maybe</a>
<a class="sourceLine" id="cb1-35" data-line-number="35">    deriving Show</a>
<a class="sourceLine" id="cb1-36" data-line-number="36">    deriving Generic</a>
<a class="sourceLine" id="cb1-37" data-line-number="37">Role</a>
<a class="sourceLine" id="cb1-38" data-line-number="38">    animeId AnimeId</a>
<a class="sourceLine" id="cb1-39" data-line-number="39">    actorId ActorId</a>
<a class="sourceLine" id="cb1-40" data-line-number="40">    name Text</a>
<a class="sourceLine" id="cb1-41" data-line-number="41">    UniqueRole animeId actorId name</a>
<a class="sourceLine" id="cb1-42" data-line-number="42">    deriving Show</a>
<a class="sourceLine" id="cb1-43" data-line-number="43">    deriving Generic</a>
<a class="sourceLine" id="cb1-44" data-line-number="44">|]</a>
<a class="sourceLine" id="cb1-45" data-line-number="45"></a>
<a class="sourceLine" id="cb1-46" data-line-number="46"><span class="ot">runDB ::</span> (<span class="dt">MonadBaseControl</span> <span class="dt">IO</span> m, <span class="dt">MonadIO</span> m) <span class="ot">=&gt;</span> <span class="dt">ReaderT</span> <span class="dt">SqlBackend</span> (<span class="dt">NoLoggingT</span> (<span class="dt">ResourceT</span> m)) a <span class="ot">-&gt;</span> m a</a>
<a class="sourceLine" id="cb1-47" data-line-number="47">runDB f <span class="fu">=</span> runSqlite <span class="st">&quot;db.sqlite&quot;</span> f</a>
<a class="sourceLine" id="cb1-48" data-line-number="48"></a>
<a class="sourceLine" id="cb1-49" data-line-number="49"><span class="ot">runMigrationIO ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb1-50" data-line-number="50">runMigrationIO <span class="fu">=</span> runDB <span class="fu">$</span> runMigration migrateAll</a></code></pre></div>
<p><code>show</code>をすると長くなりがちなレコードをログとして出していて、4Kのよさを改めて実感した。</p>
<p>型チェックだけをしたい。<a href="https://stackoverflow.com/questions/12373722/make-ghc-only-type-check">SOにそういった趣旨の質問があるが</a> stackからは使いにくそう。<a href="https://github.com/commercialhaskell/stack/issues/977">誰かに実装してほしい。</a></p>
<p>自分の日報への言及を見ると嬉しくなる。続けていきたい。</p>
<p>pandocにself-containedオプションを渡しているため、画像が全部base64エンコードされて埋め込まれるようになっている。そのせいで高解像度の画像を載せるとページの大きさが大変なことになってしまう。</p>
<p>簡単に扱える画像ホスティングサービスが欲しい。</p>
<p>昼食の帰り（外食だった）に買ったコーヒーの缶を飲んでいる。気付くと頭痛がしなくなっているから、今回は多分カフェイン切れ。</p>
<p>あーだこーだやってる内にスクレイピングが終わった。</p>
<pre><code>$ sqlite3 db.sqlite
SQLite version 3.21.0 2017-10-24 18:55:49
Enter &quot;.help&quot; for usage hints.
sqlite&gt; .tables
actor  anime  role
sqlite&gt; select count(*) from actor;
4124
sqlite&gt; select count(*) from anime;
4814
sqlite&gt; select count(*) from role;
100555</code></pre>
<p>声優の数とアニメの数がほぼ1:1なのが少し意外。アニメ一つに参加する声優の人数の平均をnとすると声優一人あたり参加するアニメの総数の平均もほぼn個ってことかな？</p>
<pre><code>$ sqlite3 db.sqlite
SQLite version 3.21.0 2017-10-24 18:55:49
Enter &quot;.help&quot; for usage hints.
sqlite&gt; select avg(cnt) from (select count(*) as cnt from role group by anime_id);
20.8880348982135
sqlite&gt; select avg(cnt) from (select count(*) as cnt from role group by actor_id);
26.0843060959792</code></pre>
<p>そのようだ。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" data-line-number="1">$ <span class="fu">sort</span> output <span class="kw">|</span> <span class="fu">uniq</span> -c <span class="kw">|</span> <span class="fu">grep</span> DUP</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">    <span class="ex">106</span> !!!DUPLICATE DETECTED!!!</a></code></pre></div>
<p>重複し過ぎでは。</p>
<p>幅優先探索を走らせているが、sequencesのFastQueueを使ったら謎のランタイムエラーが出たから2つのリストを使ってQueueを自作して使った。型エラーを適当に直したところそのまま動いた。Haskellのそういうところがいいんだよな。</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">module</span> <span class="dt">Queue</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="kw">data</span> <span class="dt">Queue</span> a <span class="fu">=</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4">    <span class="dt">Queue</span> [a] [a]</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">    <span class="kw">deriving</span> <span class="dt">Show</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6"></a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="ot">isEmpty ::</span> <span class="dt">Queue</span> a <span class="ot">-&gt;</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8">isEmpty (<span class="dt">Queue</span> [] []) <span class="fu">=</span> <span class="dt">True</span></a>
<a class="sourceLine" id="cb5-9" data-line-number="9">isEmpty _ <span class="fu">=</span> <span class="dt">False</span></a>
<a class="sourceLine" id="cb5-10" data-line-number="10"></a>
<a class="sourceLine" id="cb5-11" data-line-number="11"><span class="ot">empty ::</span> <span class="dt">Queue</span> a</a>
<a class="sourceLine" id="cb5-12" data-line-number="12">empty <span class="fu">=</span> <span class="dt">Queue</span> [] []</a>
<a class="sourceLine" id="cb5-13" data-line-number="13"></a>
<a class="sourceLine" id="cb5-14" data-line-number="14"><span class="ot">singleton ::</span> a <span class="ot">-&gt;</span> <span class="dt">Queue</span> a</a>
<a class="sourceLine" id="cb5-15" data-line-number="15">singleton x <span class="fu">=</span> <span class="dt">Queue</span> [x] []</a>
<a class="sourceLine" id="cb5-16" data-line-number="16"></a>
<a class="sourceLine" id="cb5-17" data-line-number="17"><span class="ot">push ::</span> <span class="dt">Queue</span> a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Queue</span> a</a>
<a class="sourceLine" id="cb5-18" data-line-number="18">push (<span class="dt">Queue</span> ins outs) x <span class="fu">=</span> <span class="dt">Queue</span> (x<span class="fu">:</span>ins) outs</a>
<a class="sourceLine" id="cb5-19" data-line-number="19"></a>
<a class="sourceLine" id="cb5-20" data-line-number="20"><span class="ot">pop ::</span> <span class="dt">Queue</span> a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> (a, <span class="dt">Queue</span> a)</a>
<a class="sourceLine" id="cb5-21" data-line-number="21">pop (<span class="dt">Queue</span> [] []) <span class="fu">=</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb5-22" data-line-number="22">pop (<span class="dt">Queue</span> ins []) <span class="fu">=</span></a>
<a class="sourceLine" id="cb5-23" data-line-number="23">    <span class="dt">Just</span> (x, <span class="dt">Queue</span> [] xs)</a>
<a class="sourceLine" id="cb5-24" data-line-number="24">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb5-25" data-line-number="25">    (x<span class="fu">:</span>xs) <span class="fu">=</span> reverse ins</a>
<a class="sourceLine" id="cb5-26" data-line-number="26">pop (<span class="dt">Queue</span> ins (x<span class="fu">:</span>xs)) <span class="fu">=</span> <span class="dt">Just</span> (x, <span class="dt">Queue</span> ins xs)</a></code></pre></div>
<p>上手く行った！試しに「水瀬いのり」と「水樹奈々」の距離を計測してみた。</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co">{- 省略 -}</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="ot">bfs ::</span> <span class="dt">Key</span> <span class="dt">M.Actor</span> <span class="ot">-&gt;</span> <span class="dt">S.Set</span> (<span class="dt">Key</span> <span class="dt">M.Actor</span>) <span class="ot">-&gt;</span> <span class="dt">Q.Queue</span> (<span class="dt">Int</span>, (<span class="dt">Key</span> <span class="dt">M.Actor</span>)) <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">Int</span>)</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">bfs idToFind visited q <span class="fu">=</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4">    <span class="kw">case</span> Q.pop q <span class="kw">of</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5">        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> return <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6">        <span class="dt">Just</span> ((n, aId), q&#39;)</a>
<a class="sourceLine" id="cb6-7" data-line-number="7">            <span class="fu">|</span> aId <span class="fu">==</span> idToFind <span class="ot">-&gt;</span> return <span class="fu">$</span> <span class="dt">Just</span> n</a>
<a class="sourceLine" id="cb6-8" data-line-number="8">            <span class="fu">|</span> n <span class="fu">&gt;</span> <span class="dv">3</span> <span class="ot">-&gt;</span> return <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9">            <span class="fu">|</span> otherwise <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10">                print (n, aId) </a>
<a class="sourceLine" id="cb6-11" data-line-number="11">                <span class="fu">!</span>nextQ <span class="ot">&lt;-</span> M.runDB <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb6-12" data-line-number="12">                    animeIds <span class="ot">&lt;-</span> fmap (M.roleAnimeId <span class="fu">.</span> entityVal) <span class="fu">&lt;$&gt;</span> selectList [ <span class="dt">M.RoleActorId</span> <span class="fu">==.</span> aId ] []</a>
<a class="sourceLine" id="cb6-13" data-line-number="13">                    nextIds <span class="ot">&lt;-</span> fmap (removeDups <span class="fu">.</span> concat) <span class="fu">&lt;$&gt;</span> forM animeIds <span class="fu">$</span> \animeId_ <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb6-14" data-line-number="14">                        fmap (M.roleActorId <span class="fu">.</span> entityVal) <span class="fu">&lt;$&gt;</span> selectList [ <span class="dt">M.RoleAnimeId</span> <span class="fu">==.</span> animeId_, <span class="dt">M.RoleActorId</span> <span class="fu">!=.</span> aId ] []</a>
<a class="sourceLine" id="cb6-15" data-line-number="15">                    return <span class="fu">.</span> queue <span class="fu">$</span> filter (\i <span class="ot">-&gt;</span> S.notMember i visited) nextIds</a>
<a class="sourceLine" id="cb6-16" data-line-number="16">                bfs idToFind (S.insert aId visited) nextQ</a>
<a class="sourceLine" id="cb6-17" data-line-number="17">              <span class="kw">where</span></a>
<a class="sourceLine" id="cb6-18" data-line-number="18"><span class="ot">                queue ::</span> [<span class="dt">Key</span> <span class="dt">M.Actor</span>] <span class="ot">-&gt;</span> <span class="dt">Q.Queue</span> (<span class="dt">Int</span>, (<span class="dt">Key</span> <span class="dt">M.Actor</span>))</a>
<a class="sourceLine" id="cb6-19" data-line-number="19">                queue <span class="fu">=</span> foldl&#39; Q.push q&#39; <span class="fu">.</span> fmap ((,) (n<span class="fu">+</span><span class="dv">1</span>))</a>
<a class="sourceLine" id="cb6-20" data-line-number="20"></a>
<a class="sourceLine" id="cb6-21" data-line-number="21"><span class="ot">calculateSeperationNumber ::</span> <span class="dt">T.Text</span> <span class="ot">-&gt;</span> <span class="dt">T.Text</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">Int</span>)</a>
<a class="sourceLine" id="cb6-22" data-line-number="22">calculateSeperationNumber a b <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb6-23" data-line-number="23">    (aId, bId) <span class="ot">&lt;-</span> M.runDB <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb6-24" data-line-number="24">        aId <span class="ot">&lt;-</span> entityKey <span class="fu">.</span> fromJust <span class="fu">&lt;$&gt;</span> selectFirst [ <span class="dt">M.ActorName</span> <span class="fu">==.</span> a ] []</a>
<a class="sourceLine" id="cb6-25" data-line-number="25">        bId <span class="ot">&lt;-</span> entityKey <span class="fu">.</span> fromJust <span class="fu">&lt;$&gt;</span> selectFirst [ <span class="dt">M.ActorName</span> <span class="fu">==.</span> b ] []</a>
<a class="sourceLine" id="cb6-26" data-line-number="26">        liftIO <span class="fu">$</span> uprint (aId, bId)</a>
<a class="sourceLine" id="cb6-27" data-line-number="27">        return (aId, bId)</a>
<a class="sourceLine" id="cb6-28" data-line-number="28">    bfs aId S.empty (Q.singleton (<span class="dv">0</span>, bId))</a>
<a class="sourceLine" id="cb6-29" data-line-number="29"></a>
<a class="sourceLine" id="cb6-30" data-line-number="30"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb6-31" data-line-number="31">main <span class="fu">=</span> <span class="kw">do</span> </a>
<a class="sourceLine" id="cb6-32" data-line-number="32">    E.setLocaleEncoding E.utf8</a>
<a class="sourceLine" id="cb6-33" data-line-number="33">    result <span class="ot">&lt;-</span> calculateSeperationNumber <span class="st">&quot;水瀬いのり&quot;</span> <span class="st">&quot;水樹奈々&quot;</span></a>
<a class="sourceLine" id="cb6-34" data-line-number="34">    print result</a></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb7-1" data-line-number="1">$ <span class="ex">stack</span> exec scrape <span class="op">&gt;</span> results</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">$ <span class="fu">head</span> results</a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="kw">(</span><span class="ex">ActorKey</span> {unActorKey = SqlBackendKey {unSqlBackendKey = 2578}},<span class="ex">ActorKey</span> {unActorKey = SqlBackendKey {unSqlBackendKey = 2573}}<span class="kw">)</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="kw">(</span><span class="ex">0</span>,ActorKey {unActorKey = SqlBackendKey {unSqlBackendKey = 2573}}<span class="kw">)</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="kw">(</span><span class="ex">1</span>,ActorKey {unActorKey = SqlBackendKey {unSqlBackendKey = 1}}<span class="kw">)</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="kw">(</span><span class="ex">1</span>,ActorKey {unActorKey = SqlBackendKey {unSqlBackendKey = 7}}<span class="kw">)</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="kw">(</span><span class="ex">1</span>,ActorKey {unActorKey = SqlBackendKey {unSqlBackendKey = 8}}<span class="kw">)</span></a>
<a class="sourceLine" id="cb7-8" data-line-number="8"><span class="kw">(</span><span class="ex">1</span>,ActorKey {unActorKey = SqlBackendKey {unSqlBackendKey = 28}}<span class="kw">)</span></a>
<a class="sourceLine" id="cb7-9" data-line-number="9"><span class="kw">(</span><span class="ex">1</span>,ActorKey {unActorKey = SqlBackendKey {unSqlBackendKey = 29}}<span class="kw">)</span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10"><span class="kw">(</span><span class="ex">1</span>,ActorKey {unActorKey = SqlBackendKey {unSqlBackendKey = 30}}<span class="kw">)</span></a>
<a class="sourceLine" id="cb7-11" data-line-number="11"><span class="kw">(</span><span class="ex">1</span>,ActorKey {unActorKey = SqlBackendKey {unSqlBackendKey = 38}}<span class="kw">)</span></a>
<a class="sourceLine" id="cb7-12" data-line-number="12"><span class="kw">(</span><span class="ex">1</span>,ActorKey {unActorKey = SqlBackendKey {unSqlBackendKey = 41}}<span class="kw">)</span></a>
<a class="sourceLine" id="cb7-13" data-line-number="13">$ <span class="fu">tail</span> results</a>
<a class="sourceLine" id="cb7-14" data-line-number="14"><span class="kw">(</span><span class="ex">2</span>,ActorKey {unActorKey = SqlBackendKey {unSqlBackendKey = 2559}}<span class="kw">)</span></a>
<a class="sourceLine" id="cb7-15" data-line-number="15"><span class="kw">(</span><span class="ex">2</span>,ActorKey {unActorKey = SqlBackendKey {unSqlBackendKey = 2562}}<span class="kw">)</span></a>
<a class="sourceLine" id="cb7-16" data-line-number="16"><span class="kw">(</span><span class="ex">2</span>,ActorKey {unActorKey = SqlBackendKey {unSqlBackendKey = 2563}}<span class="kw">)</span></a>
<a class="sourceLine" id="cb7-17" data-line-number="17"><span class="kw">(</span><span class="ex">2</span>,ActorKey {unActorKey = SqlBackendKey {unSqlBackendKey = 2568}}<span class="kw">)</span></a>
<a class="sourceLine" id="cb7-18" data-line-number="18"><span class="kw">(</span><span class="ex">2</span>,ActorKey {unActorKey = SqlBackendKey {unSqlBackendKey = 2569}}<span class="kw">)</span></a>
<a class="sourceLine" id="cb7-19" data-line-number="19"><span class="kw">(</span><span class="ex">2</span>,ActorKey {unActorKey = SqlBackendKey {unSqlBackendKey = 2574}}<span class="kw">)</span></a>
<a class="sourceLine" id="cb7-20" data-line-number="20"><span class="kw">(</span><span class="ex">2</span>,ActorKey {unActorKey = SqlBackendKey {unSqlBackendKey = 2575}}<span class="kw">)</span></a>
<a class="sourceLine" id="cb7-21" data-line-number="21"><span class="kw">(</span><span class="ex">2</span>,ActorKey {unActorKey = SqlBackendKey {unSqlBackendKey = 2576}}<span class="kw">)</span></a>
<a class="sourceLine" id="cb7-22" data-line-number="22"><span class="kw">(</span><span class="ex">2</span>,ActorKey {unActorKey = SqlBackendKey {unSqlBackendKey = 2577}}<span class="kw">)</span></a>
<a class="sourceLine" id="cb7-23" data-line-number="23"><span class="ex">Just</span> 2</a></code></pre></div>
<p>しかし時間がかかりすぎるのと、経路が欲しい。</p>
<p>Sqliteに投げるべき制約を手元で解いていたことに気づいた。</p>
<p>foldl/foldl’/foldrでどれがどれなのかわからなって毎回 <a href="https://stackoverflow.com/questions/384797/implications-of-foldr-vs-foldl-or-foldl" class="uri">https://stackoverflow.com/questions/384797/implications-of-foldr-vs-foldl-or-foldl</a> に行き着いて解決する。いい加減覚えたい。</p>
<p>声優が出演するアニメの全ての声優が出演するアニメの和集合をPersistentに渡したら “parser stack overflow”と出て笑った。</p>
<p>ORでかかる制約を一つ一つSQLiteに投げるより一つのクエリにして投げたほうがいいだろうとふんでまとめて投げたら（多分）SQLiteのパーサがオーバーフローするから制約10個をまとめて投げる方式に切り替えたら寧ろ10倍オーダーで遅くなった。むむ、となって一つひとつ投げる方式に戻してメモリプロファイリングを掛けたら<strong>のべ100GB以上のアロケーション</strong>が発生していた。</p>
<p>えいやと適当なところにStrictness Annotation付けたらアロケーション量がだいぶ減ったが、未だにアホみたいな量のアロケーションが発生しているしパフォーマンスも芳しくないということで<code>stack build --profile</code>を実行したら全ての依存パッケージの再ビルドが始まって真顔になっている。</p>
<p>去年の4月にノートパソコンを購入した当時はi7だし機械学習でもやろうとしない限り問題ないだろうと高を括っていたが、NixのビルドといいHaskellのビルドといい CPUの4つのコアが100%に張り付いてブラウザの動きがトロくなってくることが多い。半分冗談でデスクトップマシンの調達の話をこの間の#class-aiでしていたが、購入の検討をしなければいけないかもしれない。</p>
<p>ページの重さといえば<a href="http://idlewords.com/talks/website_obesity.htm">The Website Obesity Crisis</a> が好き。Maciej Ceglowski氏のスライドはどれも面白い。</p>
<h3 id="watchしている日報">watchしている日報</h3>
<ul>
<li><a href="https://nippo.wikihub.io/@azyobuzin/articles" class="uri">https://nippo.wikihub.io/@azyobuzin/articles</a></li>
<li><a href="https://to-be-real.tumblr.com/" class="uri">https://to-be-real.tumblr.com/</a></li>
<li><a href="https://diary.sh4869.net/" class="uri">https://diary.sh4869.net/</a></li>
<li><a href="https://strict-flower.tumblr.com/" class="uri">https://strict-flower.tumblr.com/</a></li>
</ul>
<p>ツイッターを見ていると全員が何かしらの成果を常に出していかのような錯覚に陥って必要以上に焦燥感に駆られるが、日報を見ると各位が適度に休みながら進捗と成果を出している様子が見れる。変に力まずに済んで精神衛生上良い。みんな面白そうなことやってるのを見るの楽しいしね。</p>
<h3 id="今日のbgm">今日のBGM</h3>
<ul>
<li><a href="https://soundcloud.com/tobato/listen-to-the-music-mashup">Listen To The Music (オオカミハート Mashup)</a></li>
<li><a href="https://soundcloud.com/tobato/rdcmqw5b8i0y">最強@メイト計画</a></li>
<li><a href="https://soundcloud.com/tobato/aimsmonolith-slip-bootlegbootleg">AIMS(monolith slip BootlegのBootleg)</a></li>
<li><a href="https://www.youtube.com/watch?v=a_rrj1Xh5LI">《公式》フラジール / GUMI</a></li>
</ul>
<h2 id="明日やるべきこと">明日やるべきこと</h2>
<ul>
<li>メールを出す</li>
<li>大学に行く</li>
<li>確定申告・精算</li>
<li>Rust</li>
<li>Econometrics</li>
<li>スクレイピングが上手くいったら#haskell-beginnerのshaprに報告すること</li>
<li>3DMM</li>
<li>画像処理調べもの</li>
</ul>
<section class="footnotes">
<hr />
<ol>
<li id="fn1"><p>a feeling of uneasinessと形容したくて“uneasiness”で英和辞書をひいたら「不安、心配、困惑」と出てきて、どれも意味としては強すぎる気がして結局曖昧な言葉遣いを選んだ。和文で自分を表現するのが下手なのか、日本語では表現することができない感情を表現しようとしているのか。サピア=ウォーフ仮説を引き合いに出して洒落たことを言ってみたいが、特に言えることはない。<a href="#fnref1" class="footnote-back">↩</a></p></li>
<li id="fn2"><p>これはNixにも言えることで、そういう話を友人にしたら「全員がそれを使えばハッピーになれるのは、任意の技術基盤について言えない？」と指摘されて、それもそうだなとなった。<a href="#fnref2" class="footnote-back">↩</a></p></li>
<li id="fn3"><p>「関数型言語」は定義が存在しないため意味不明だという主張があって、藁人形論法の元にもなりうるし基本的に同意できるがFunctional Paradigmに言及したい時に困ってしまう。OCaml/SML/Haskell/etc.の言語をまとめてML系の言語と呼ぶのはどうかという提案もある一方HaskellはML系とは言えないという主張も見て、こんな表現にとりあえず落ち着いている。<a href="#fnref3" class="footnote-back">↩</a></p></li>
</ol>
</section>
<a href="./index.html">一覧</a>
</body>
</html>
